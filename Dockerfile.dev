ARG RUBY_VERSION=3.4
FROM ruby:${RUBY_VERSION}

ENV RAILS_ENV=development \
    NODE_ENV=development \
    BUNDLE_WITHOUT=""

RUN apt-get update -qq && \
    apt-get install -y --no-install-recommends build-essential libpq-dev git curl nodejs npm && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app

COPY Gemfile Gemfile.lock ./
RUN bundle install --jobs=4 --retry=3

COPY . .

# Install JS dependencies so dev server can run the CSS watcher; actual CSS is rebuilt by bin/dev/foreman.
RUN npm install

EXPOSE 3000

ENTRYPOINT ["./bin/docker-entrypoint"]
CMD ["./bin/rails", "server", "-b", "0.0.0.0"]
